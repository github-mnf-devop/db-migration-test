name: ArgoCD Flyway Migration Sync
on:
 push:
   paths:
     - 'flyway/sql/**'   
jobs:
 sync:
   runs-on: ubuntu-latest
   steps:
     - name: ğŸ§© Checkout repository
       uses: actions/checkout@v4
     - name: ğŸ”§ Generate ConfigMap from SQL scripts
       run: |
         echo "ğŸ”§ Generating ConfigMap from flyway/sql/"
         mkdir -p flyway/k8s
         kubectl create configmap flyway-sql-config \
           --from-file=flyway/sql/ \
           --dry-run=client -o yaml > flyway/k8s/configmap.yaml
     - name: ğŸ“ Commit updated configmap.yaml
       run: |
         echo "ğŸ“ Committing updated configmap.yaml"
         git config user.name "github-actions[bot]"
         git config user.email "github-actions[bot]@users.noreply.github.com"
         git add flyway/k8s/configmap.yaml
         git commit -m "Update ConfigMap from SQL scripts" || echo "No changes to commit"
         git push || echo "No changes to push"
     - name: ğŸš€ Trigger ArgoCD Sync
       run: |
         echo "ğŸš€ Triggering ArgoCD sync for flyway-migration-demo..."
         curl -k -X POST \
           -u "${{ secrets.ARGOCD_USERNAME }}:${{ secrets.ARGOCD_PASSWORD }}" \
           "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/flyway-migration-demo/sync"
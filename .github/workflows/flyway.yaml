name: Flyway Migration Auto Sync
on:
 push:
   paths:
     - main
 workflow_dispatch:
jobs:
 migrate:
   runs-on: ubuntu-latest
   steps:
     - name: Checkout repository
       uses: actions/checkout@v4
     - name: Generate new ConfigMap from SQL scripts
       run: |
         echo "üîß Generating ConfigMap from flyway/sql/"
         kubectl create configmap flyway-sql-config \
           --from-file=flyway/sql/ \
           --dry-run=client -o yaml > k8s/configmap.yaml
     - name: Commit updated ConfigMap
       run: |
         echo "üìù Committing updated configmap.yaml"
         git config user.name "github-actions"
         git config user.email "actions@github.com"
         git add k8s/configmap.yaml
         git commit -m "Auto-update configmap with new SQL migrations" || echo "No changes to commit"
         git push
     - name: Trigger ArgoCD Sync
       run: |
         echo "üöÄ Triggering ArgoCD sync for flyway-migration-demo..."
         curl -k -X POST \
           -u "${{ secrets.ARGOCD_USERNAME }}:${{ secrets.ARGOCD_PASSWORD }}" \
           "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/flyway-migration-demo/sync"